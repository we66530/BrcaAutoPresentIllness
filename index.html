<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patient History Summarizer (Gemini API)</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; background: #f7f7fb; color: #111; }
    textarea { width: 100%; height: 200px; margin-top: 10px; padding: 10px; border-radius: 8px; }
    button { margin-top: 10px; padding: 10px 20px; border: none; border-radius: 6px; background: #111827; color: white; cursor: pointer; }
    input, select { padding: 8px; border-radius: 6px; border: 1px solid #ddd; width: 100%; margin-top: 5px; }
    #output { margin-top: 20px; padding: 15px; border-radius: 8px; background: #fff; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Patient History Summarizer (Gemini API)</h1>

  <label><strong>Paste patient history:</strong></label>
  <textarea id="inputText"></textarea>

  <br />
  <label><strong>Gemini API Key:</strong></label>
  <input type="password" id="apiKey" placeholder="Enter your Gemini API key" />

  <br /><br />
  <label><strong>Select model:</strong></label>
  <select id="modelSelect">
    <option value="models/gemini-2.5-flash">gemini-2.5-flash</option>
    <option value="models/gemini-2.5-pro">gemini-2.5-pro</option>
    <option value="models/gemini-2.0-flash">gemini-2.0-flash</option>
    <option value="models/gemini-2.0-flash-001">gemini-2.0-flash-001</option>
    <option value="models/gemini-2.0-flash-lite">gemini-2.0-flash-lite</option>
    <option value="models/gemini-2.0-flash-lite-001">gemini-2.0-flash-lite-001</option>
    <option value="models/gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
  </select>

  <button id="summarizeBtn">Summarize</button>

  <div id="output"></div>

  <script>
    const promptPrefix = `Can you organize the following unstructured patient information into this structured format?
(Remember: Do NOT use abbreviations or synonyms. Always expand to full names.)

Chief Complaint
Condition 1: (Right/Left) breast lump for XXX (how long)
Condition 2: (Right/Left) breast microcalcification found on screening mammography on XXXX/XX/XX

Present Illness
There is a XX-year-old woman with a history of:
# Diagnosis 1 (Cancer 1)
- Status post ….(surgery) on XXXX/XX/XX
- Status post ….(systemic therapy) on XXXX/XX/XX
## Restaging shows TxNxMx on XXXX/XX/XX
- Status post ….(surgery) on XXXX/XX/XX
- Status post ….(systemic therapy) on XXXX/XX/XX

# Diagnosis 2 (Cancer 2)
- Status post ….(surgery) on XXXX/XX/XX
- Status post ….(systemic therapy) on XXXX/XX/XX
## Restaging shows TxNxMx on XXXX/XX/XX
- Status post ….(surgery) on XXXX/XX/XX
- Status post ….(systemic therapy) on XXXX/XX/XX

—---Underlying—--
# Chronic disease 1 (e.g., Diabetes Mellitus, Hypertension) …
# Chronic disease 2 (e.g., Diabetes Mellitus, Hypertension) …

(main paragraph)
She first notices there is a (Left/Right) breast lump on XXXX/XX/XX, then first seeks medical assistance at XXXXX. Then, she received a serial examination, including XXX, XXX, which showed XXX, XXX results respectively.
* If there is a mammography result, please present with “BI-RADS (Breast Imaging Reporting and Data System) grade XXX”.
Based on the above examination result, we discussed the treatment plan with her, and she consented to XXX. Therefore, she was admitted on XXXX/XX/XX for XXX on XXXX/XX/XX.

Tentative Diagnosis
# (Right/Left) Invasive carcinoma of no special type, grade 2, Estrogen receptor: positive (95%), Progesterone receptor: negative (0%), Human epidermal growth factor receptor 2: negative (score 0), luminal type xxx, TxNxMx, stage

Special rule:
- If the patient has NO cancer history, print:
  "There is a XX-year-old woman with a history of:
  # (no related past history)
  —---Underlying—--
  # (no underlying disease)"
- No abbreviation allowed. Always expand into full names.
---\n\n`;

    function extractAge(text) {
      const match = text.match(/(\d{2})\s*(y\/o|years? old)?/i);
      if (match) return match[1] + " years old";
      return "";
    }

    function ensureHistoryExists(summary, ageStr) {
      if (!/Diagnosis|Chronic disease/i.test(summary)) {
        return `There is a ${ageStr || "XX years old"} woman with a history of:\n# (no related past history)\n—---Underlying—--\n# (no underlying disease)`;
      }
      return summary;
    }

    function expandAbbreviations(text) {
      const replacements = {
        "\\bRt\\b": "Right",
        "\\bLt\\b": "Left",
        "\\bPM\\b": "Partial mastectomy",
        "\\bTM\\b": "Total mastectomy",
        "\\bMRM\\b": "Modified radical mastectomy",
        "\\bPort-A\\b": "Infraclavicular venous port implantation",
        "\\bALN\\b": "Axillary lymph node",
        "\\bClipping\\b": "Clip placement",
        "\\bARM\\b": "Axillary reverse mapping",
        "\\bVABB\\b": "Vacuum-assisted partial mastectomy",
        "\\bBI-RADS\\b": "BI-RADS (Breast Imaging Reporting and Data System)"
      };
      for (const [abbr, full] of Object.entries(replacements)) {
        text = text.replace(new RegExp(abbr, "g"), full);
      }
      return text;
    }

    document.getElementById("summarizeBtn").addEventListener("click", async () => {
      const apiKey = document.getElementById("apiKey").value.trim();
      const inputText = document.getElementById("inputText").value.trim();
      const model = document.getElementById("modelSelect").value;
      const outputDiv = document.getElementById("output");

      if (!apiKey) {
        alert("Please enter your Gemini API key.");
        return;
      }
      if (!inputText) {
        alert("Please paste patient history.");
        return;
      }

      outputDiv.textContent = "Summarizing... please wait.";
      const ageStr = extractAge(inputText);

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1/${model}:generateContent?key=${apiKey}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: promptPrefix + inputText }] }]
            })
          }
        );

        const data = await response.json();

        if (data.candidates && data.candidates.length > 0) {
          let summary = data.candidates[0].content.parts[0].text;
          summary = ensureHistoryExists(summary, ageStr);
          summary = expandAbbreviations(summary); // enforce full names
          outputDiv.textContent = (ageStr ? ageStr + "\n" : "") + summary;
        } else {
          outputDiv.textContent = "No summary returned. Full response:\n" + JSON.stringify(data, null, 2);
        }
      } catch (err) {
        outputDiv.textContent = "Error: " + err.message;
      }
    });
  </script>
</body>
</html>
